<!DOCTYPE html>
<html>
	<head>
		<meta charset="utf-8">
		<title></title>
		<style type="text/css">
			html,
			body {
				/* width: 100em; */
				height: 100vh;
				margin: 0 4px;
			}

			#audio-url {
				width: 245px;
			}

			#canvas {
				/* background-color: #263238; */
				border: 1px solid #17A2B8;
				width: 100%;
				/* width: 1800px; */
				/* height: 320px;				 */
				height: calc(50% - 100px);
				/* height: 30%; */
			}

			#canvas-spec {
				border: 1px solid #17A2B8;
				width: 100%;
				height: 20%;
			}
		</style>
	</head>
	<body>
		<div class="">
			<div class="">
				<input type="file" name="" id="audio-file" value="" />
				<button type="button" id="load">加载</button>
				<!-- <input type="image" src="img/画画.png" alt="" /> -->
			</div>
			<div class="">
				<input type="text" name="" id="audio-url" value="" />
				<button type="button" id="loadFromRemote">远程加载</button>
			</div>
			<div class="">
				<button type="button" id="reset">复位</button>
				<input type="text" name="" id="play_start" value="" placeholder="开始时间" />
				<input type="text" name="" id="play_end" value="" placeholder="结束时间" />
				<button type="button" id="playCurRegion">播放当前区域</button>
				<button type="button" id="playAllRegion">播放所有区域</button>
				<button type="button" id="initRegions">设置区域</button>
				<button type="button" id="edit">裁剪</button>
				<button type="button" id="play">播放</button>
				<button type="button" id="stop">暂停</button>
				<input type="range" id="volumeCtrl" min="0" max="100" value="100" />
			</div>
			<div class="">
				<input type="color" name="" id="region-color" />
				<button type="button" id="setRegionColor">设置颜色</button>
				<button type="button" id="test">测试</button>
			</div>
			<div class="">
				<input type="number" name="" id="audio-channel" value="0" />
				<button type="button" id="getChannelData">提取音轨</button>
			</div>
		</div>
		<div class="">
			采样率：<label id="sampleRate"></label>
			位深：<label id="sampleBit"></label>
			时长：<label id="duration"></label>
			通道数：<label id="numberOfChannels"></label>
		</div>

		<!-- <canvas id="canvas" height="320"></canvas> -->
		<canvas id="canvas"></canvas>
		<canvas id="canvas-spec"></canvas>
		<script type="module">
			import {
				AudioViewer,
				Spectrogram
			} from '../index.js';
			var audioViewer = null;
			var audioViewer1 = null;
			var ws = null;
			window.onload = function() {
				audioViewer = new AudioViewer({
					canvas: document.getElementById('canvas'),
					// waveColor: '#000',
					// waveBarGap: 2,
					// waveBarWidth: 3,
					// waveBarCap: 'round',
					// playOnly: true,
					// autoLoop: true,
					seekToStartOnEnd: false,
					// volume: 0.2,
					// displayTimeLine: false,
					// displayLoadProgress: false,
					// displayAllChannel: false,
					// displayPlayOverlay: true,
					// ,fileUrl: "http://192.168.0.112:8090/original/a001.wav"
					// ,regions: [{startTime: 10, endTime: 20}, {startTime: 50, endTime: 70}],
					plugins: [
						// new Spectrogram({canvas: document.getElementById('canvas-spec')})
					]
				})
				audioViewer.registerPauseListener(pl);
				audioViewer.registerEndListener(el);
				// audioViewer1 = new AudioViewer({
				// 	canvas: document.getElementById('canvas1')
				// })
				document.getElementById('load').onclick = loadFromLocal;
				document.getElementById('loadFromRemote').onclick = loadFromRemote;
				document.getElementById('playCurRegion').onclick = playCurRegion;
				document.getElementById('playAllRegion').onclick = playAllRegion;
				document.getElementById('initRegions').onclick = initRegions;
				document.getElementById('edit').onclick = edit;
				document.getElementById('play').onclick = play;
				document.getElementById('stop').onclick = stop;
				document.getElementById('reset').onclick = reset;
				document.getElementById('volumeCtrl').oninput = volumeChange;
				document.getElementById('setRegionColor').onclick = setRegionColor;
				document.getElementById('getChannelData').onclick = getChannelData;
				document.getElementById('test').onclick = test;
			}
			let pl = (time) => {
				// console.log(1111, time);
			}
			let el = () => {
				// console.log(2222);
			}
			window.addEventListener("keypress", (e) => {
				// console.log(e.keyCode);
				if (e.keyCode == 32 && audioViewer) {
					audioViewer.toggle();
				}
			});

			// http://192.168.0.112:8090/test.wav
			function loadFromRemote() {
				let inputFile = document.getElementById('audio-url');
				audioViewer.loadUrl(inputFile.value, null, () => {
					alert("文件解析失败.");
				});
			}

			function loadFromLocal(no) {
				let inputFile = document.getElementById('audio-file');
				let files = inputFile.files;
				if (files.length > 0) {
					let file = files[0];
					audioViewer.loadFile(file, () => {
						let audioInfo = audioViewer.getAudioInfo();
						document.getElementById('sampleRate').innerHTML = audioInfo.sampleRate;
						// document.getElementById('sampleBit').innerHTML = sampleBits;
						document.getElementById('duration').innerHTML = audioInfo.duration;
						document.getElementById('numberOfChannels').innerHTML = audioInfo.numberOfChannels;
					}, () => {
						alert("文件解析失败.");
					});
					if (audioViewer1) {
						audioViewer1.loadFile(file);
					}
				}
			}

			function reset(no) {
				audioViewer.reset()
			}

			function playCurRegion() {
				let region = audioViewer.getCurrentRegion();
				if (region) {
					document.getElementById('play_start').value = region.startTime;
					document.getElementById('play_end').value = region.endTime;
				}
				audioViewer.playCurrentRegion();
			}

			function play(no) {
				audioViewer.play({
					onend: () => {
						console.log(1111111)
					}
				});
			}

			function stop(no) {
				audioViewer.pause();
			}

			function playAllRegion() {
				audioViewer.playRegions();
			}

			function edit() {
				let newBlob = audioViewer.editRegions();
				let url = URL.createObjectURL(newBlob);
				console.log(url);
				let a = document.createElement('a');
				a.href = url;
				a.download = 'aaaa.wav';
				a.click();
				URL.revokeObjectURL(a.href);
				a.remove();
			}

			function initRegions() {
				let regions = [{
						startTime: 10,
						endTime: 15
					},
					{
						startTime: 19.259,
						endTime: 23.762
					}
				]
				audioViewer.initRegions(regions);
			}

			function volumeChange(e) {
				audioViewer.setVolume(e.target.value / 100);
			}

			function getChannelData() {
				let audioChannel = document.getElementById('audio-channel');
				let newBlob = audioViewer.getChannelData(audioChannel.value);
				console.log(newBlob)
				let url = URL.createObjectURL(newBlob);
				console.log(url);
				let a = document.createElement('a');
				a.href = url;
				a.download = 'aaaa.wav';
				a.click();
				URL.revokeObjectURL(a.href);
				a.remove();
			}

			function setRegionColor() {
				let col = document.getElementById('region-color').value;
				audioViewer.getCurrentRegion().color = col;
			}
			let displayTimeLine = false;

			function test() {
				// audioViewer.set({
				// 	displayTimeLine: displayTimeLine,
				// 	displayAllChannel: false,
				// 	displayPlayOverlay: false,
				// 	playOnly: true,
				// 	waveColor: 'gray',
				// 	regionColor: 'rgba(255, 100, 100, 0.1)',
				// 	curRegionColor: 'rgba(255, 100, 100, 0.3)',
				// 	regionBorderColor: 'rgba(255, 100, 100, 1)',
				// 	waveBarWidth: 5,
				// 	waveBarGap: 3,
				// 	waveBarCap: 'round' //'butt'|'round'|'square'
				// });
				// displayTimeLine = !displayTimeLine;
				// let col = document.getElementById('region-color').value;
				// audioViewer.playRegions({
				// 	filter: region => region.color && region.color == col,
				// 	onend: () => console.log('end to play regions')
				// })
				// let col = document.getElementById('region-color').value;
				// let newBlob = audioViewer.editRegions({
				// 	filter: (region) => {
				// 		return region.color && region.color == col
				// 	}
				// })
				// let url = URL.createObjectURL(newBlob);
				// console.log(url);
				// let a = document.createElement('a');
				// a.href = url;
				// a.download = 'aaaa.wav';
				// a.click();
				// URL.revokeObjectURL(a.href);
				// a.remove();
				audioViewer.toggle(() => {
					console.log('ended!!!');
				})
			}
		</script>
	</body>
</html>
